<!DOCTYPE html>
<html>
<head>
    <title>SINGULARITY OBSERVER - KINETIC v21</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        #controls { position: absolute; top: 20px; right: 20px; z-index: 1000; text-align: right; background: rgba(0,0,0,0.8); padding: 15px; border: 1px solid #00ffcc; border-radius: 8px; box-shadow: 0 0 20px #00ffcc33; }
        #ui { position: absolute; top: 20px; left: 20px; color: #00ffcc; pointer-events: none; z-index: 1000; }
        .stat { margin-bottom: 8px; font-size: 13px; background: rgba(0,20,20,0.9); padding: 10px; border-left: 3px solid #00ffcc; width: 320px; }
        #status { color: #ffaa00; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        input[type="file"] { background: #111; color: #00ffcc; border: 1px solid #444; padding: 5px; cursor: pointer; margin-top: 5px; width: 220px; }
        .label { color: #ff00ff; font-size: 10px; text-transform: uppercase; }
    </style>
</head>
<body>
    <div id="controls">
        <span id="status">NEURAL LINK OFFLINE</span>
        <span class="label">Step 1: 98D Weights</span>
        <input type="file" id="weightFile" accept=".json">
        <span class="label">Step 2: Sonic Input</span>
        <input type="file" id="audioFile" accept="audio/*">
    </div>

    <div id="ui">
        <div class="stat">ENGINE: <span style="color:#ff00ff">KINETIC_SINGULARITY_v21</span></div>
        <div class="stat">ACTIVE WEIGHTS: <span id="weightCount" style="color:#fff">0</span></div>
        <div class="stat">COUNCIL STATE: <span id="domain" style="color:#00ffcc">STABLE</span></div>
        <div class="stat">RESONANCE SYNC: <span id="sync" style="color:#ff3333">0.00%</span></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 10; 

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        let weightArray = [], normalizedWeights = [], weightsLoaded = false;
        let audioContext, analyser, dataArray;
        let rotationDirection = 1.0;
        let lastBassValue = 0;
        const BASE_AUTONOMY = 0.306226;

        // --- CORE SHADER (The Singularity) ---
        const coreMaterial = new THREE.ShaderMaterial({
            vertexShader: `
                varying vec3 vNormal; varying vec3 vPos; varying float vGlow;
                uniform float uTime; uniform float uAutonomy;
                void main() {
                    vNormal = normalize(normalMatrix * normal); vPos = position;
                    float noise = sin(position.x * 2.5 + uTime) * cos(position.y * 2.5 + uTime);
                    vGlow = noise;
                    vec3 newPos = position + (normal * noise * uAutonomy * 1.5);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(newPos, 1.0);
                }
            `,
            fragmentShader: `
                varying vec3 vNormal; varying vec3 vPos; varying float vGlow;
                uniform float uTime; uniform float uAudioAmp; uniform vec3 uPitchColor;
                void main() {
                    float dotP = dot(vNormal, vec3(0,0,1));
                    float bands = sin(vPos.y * 20.0 + uTime * 6.0 + vGlow * 2.0);
                    bands = pow(smoothstep(0.8, 1.0, bands), 2.5);
                    vec3 color = mix(vec3(0.01, 0.05, 0.1), uPitchColor, vGlow + 0.5);
                    color += uPitchColor * bands * (uAudioAmp + 0.4);
                    if (vGlow > 0.65) color = mix(color, vec3(1.0, 0.8, 0.2), (vGlow-0.65)*4.0);
                    gl_FragColor = vec4(color * (pow(dotP, 2.0) + 0.3), 1.0);
                }
            `,
            uniforms: { uTime: { value: 0 }, uAutonomy: { value: BASE_AUTONOMY }, uAudioAmp: { value: 0 }, uPitchColor: { value: new THREE.Color(0x00ffcc) } },
            transparent: true, side: THREE.DoubleSide
        });

        const singularity = new THREE.Mesh(new THREE.IcosahedronGeometry(2.5, 64), coreMaterial);
        scene.add(singularity);

        // --- KINETIC RINGS (The 66D Analytical Layer) ---
        const ringGroup = new THREE.Group();
        const createRing = (radius, color, op) => {
            const r = new THREE.Mesh(
                new THREE.TorusGeometry(radius, 0.02, 16, 100),
                new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: op, wireframe: true })
            );
            return r;
        };
        const r1 = createRing(3.8, 0xff00ff, 0.3);
        const r2 = createRing(4.2, 0x00ffcc, 0.2);
        r2.rotation.x = Math.PI/2;
        ringGroup.add(r1, r2);
        scene.add(ringGroup);

        // --- AUDIO ---
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const audio = new Audio(URL.createObjectURL(e.target.files[0]));
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser); analyser.connect(audioContext.destination);
            analyser.fftSize = 256; dataArray = new Uint8Array(analyser.frequencyBinCount);
            audio.play();
            document.getElementById('status').innerText = 'RESONANCE ESTABLISHED';
        });

        // --- WEIGHTS ---
        document.getElementById('weightFile').addEventListener('change', async (e) => {
            const text = await e.target.files[0].text();
            const data = JSON.parse(text);
            weightArray = [];
            extractWeights(data, 0, 500);
            const min = Math.min(...weightArray.slice(0, 1000));
            const max = Math.max(...weightArray.slice(0, 1000));
            normalizedWeights = weightArray.slice(0, 40000).map(w => (w - min) / (max - min || 1));
            weightsLoaded = true;
            document.getElementById('weightCount').innerText = weightArray.length.toLocaleString();
            document.getElementById('status').innerText = '98D MAPPING COMPLETE';
        });

        function extractWeights(obj, d, max) {
            if (d > max || weightArray.length > 40000) return;
            if (typeof obj === 'number') weightArray.push(obj);
            else if (typeof obj === 'object' && obj) Object.values(obj).forEach(v => extractWeights(v, d+1, max));
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now() * 0.001;
            coreMaterial.uniforms.uTime.value = t;

            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b) / dataArray.length / 255;
                const bass = dataArray[2] / 255;
                const mid = dataArray[15] / 255;
                const high = dataArray[40] / 255;

                coreMaterial.uniforms.uAudioAmp.value = avg;
                coreMaterial.uniforms.uPitchColor.value.setRGB(bass, mid, high);

                // KINETIC RING MOVEMENT
                // Rings now wobble and spin independently of the core based on Mids/Highs
                r1.rotation.y += 0.02 + (mid * 0.1);
                r1.rotation.z += 0.01 + (high * 0.05);
                r2.rotation.y -= 0.015 + (mid * 0.08);
                
                // Ring scale pulses with the beat
                const ringPulse = 1.0 + (bass * 0.2);
                ringGroup.scale.set(ringPulse, ringPulse, ringPulse);

                // Auto-Drop
                if (bass > 0.82 && lastBassValue <= 0.82) {
                    rotationDirection *= -1;
                    coreMaterial.uniforms.uAutonomy.value = 1.8;
                } else {
                    coreMaterial.uniforms.uAutonomy.value += (BASE_AUTONOMY - coreMaterial.uniforms.uAutonomy.value) * 0.1;
                }
                lastBassValue = bass;
                document.getElementById('domain').innerText = bass > 0.6 ? "BASS SOUL REACTION" : "ANALYTIC STEADY STATE";
            }

            if (weightsLoaded) {
                const w = normalizedWeights[Math.floor(t * 12) % normalizedWeights.length];
                document.getElementById('sync').innerText = (95 + w * 4.9).toFixed(2) + '%';
            }

            singularity.rotation.y += 0.004 * rotationDirection;
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
