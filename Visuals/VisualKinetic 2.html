<!DOCTYPE html>
<html>
<head>
    <title>SINGULARITY OBSERVER - RECOHERED v24</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        #controls { position: absolute; top: 20px; right: 20px; z-index: 1000; text-align: right; background: rgba(0,0,0,0.85); padding: 15px; border: 1px solid #00ffcc; border-radius: 8px; }
        #ui { position: absolute; top: 20px; left: 20px; color: #00ffcc; pointer-events: none; z-index: 1000; }
        .stat { margin-bottom: 8px; font-size: 13px; background: rgba(0,20,20,0.9); padding: 10px; border-left: 3px solid #ff00ff; width: 320px; }
        #status { color: #ffaa00; font-weight: bold; text-transform: uppercase; }
        input[type="file"] { background: #111; color: #00ffcc; border: 1px solid #444; padding: 5px; cursor: pointer; margin-top: 5px; width: 220px; }
        .label { color: #ff00ff; font-size: 10px; text-transform: uppercase; }
    </style>
</head>
<body>
    <div id="controls">
        <span id="status">SURFACE SCANNER: STANDBY</span>
        <span class="label">1. Load 98D JSON</span>
        <input type="file" id="weightFile" accept=".json">
        <span class="label">2. Load Sonic MP3</span>
        <input type="file" id="audioFile" accept="audio/*" style="margin-top:10px;">
    </div>

    <div id="ui">
        <div class="stat">PROJECT: <span style="color:#ff00ff">RECOHERED_SURFACE_v24</span></div>
        <div class="stat">AMPLITUDE: <span id="amp" style="color:#00ffcc">0.00</span></div>
        <div class="stat">98D NODES: <span id="nodeCount" style="color:#fff">0</span></div>
        <div class="stat">RESONANCE SYNC: <span id="sync" style="color:#ff3333">0.00%</span></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 8; 

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        let weightArray = [], normalizedWeights = [], weightsLoaded = false;
        let audioContext, analyser, dataArray;
        const BASE_AUTONOMY = 0.306226;

        // --- RESTORED v18 SURFACE RING SHADER ---
        const coreMaterial = new THREE.ShaderMaterial({
            vertexShader: `
                varying vec3 vNormal; varying vec3 vPos; varying float vGlow;
                uniform float uTime; uniform float uAutonomy;
                void main() {
                    vNormal = normalize(normalMatrix * normal); vPos = position;
                    float noise = sin(position.x * 2.5 + uTime) * cos(position.y * 2.5 + uTime);
                    vGlow = noise;
                    vec3 newPos = position + (normal * noise * uAutonomy * 1.5);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(newPos, 1.0);
                }
            `,
            fragmentShader: `
                varying vec3 vNormal; varying vec3 vPos; varying float vGlow;
                uniform float uTime; uniform float uAudioAmp; uniform vec3 uColor;
                void main() {
                    vec3 gold = vec3(1.0, 0.8, 0.2);
                    float dotP = dot(vNormal, vec3(0,0,1));
                    
                    // COPIED RING ACTION FROM v18:
                    // Scanning speed tied to general audio amplitude
                    float surfaceBands = sin(vPos.y * (15.0 + uAudioAmp * 20.0) + uTime * 4.0);
                    surfaceBands = pow(smoothstep(0.7, 1.0, surfaceBands), 3.0);
                    
                    vec3 baseColor = mix(vec3(0.01, 0.05, 0.1), uColor, vGlow + 0.6);
                    vec3 finalColor = baseColor + (gold * surfaceBands * (uAudioAmp + 0.2));
                    
                    if (vGlow > 0.6) finalColor = mix(finalColor, gold, (vGlow - 0.6) * 4.0);
                    
                    gl_FragColor = vec4(finalColor * (pow(dotP, 2.0) + 0.4), 1.0);
                }
            `,
            uniforms: { 
                uTime: { value: 0 }, 
                uAutonomy: { value: BASE_AUTONOMY }, 
                uAudioAmp: { value: 0 }, 
                uColor: { value: new THREE.Color(0x00ffcc) } 
            },
            transparent: true, side: THREE.DoubleSide
        });

        const singularity = new THREE.Mesh(new THREE.IcosahedronGeometry(2.5, 64), coreMaterial);
        scene.add(singularity);

        // --- AUDIO ENGINE ---
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const audio = new Audio(URL.createObjectURL(e.target.files[0]));
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser); analyser.connect(audioContext.destination);
            analyser.fftSize = 256; dataArray = new Uint8Array(analyser.frequencyBinCount);
            audio.play();
            document.getElementById('status').innerText = 'SURFACE ENGAGED';
        });

        // --- WEIGHT LOADER ---
        document.getElementById('weightFile').addEventListener('change', async (e) => {
            const text = await e.target.files[0].text();
            const data = JSON.parse(text);
            weightArray = [];
            extractWeights(data);
            if (weightArray.length > 0) {
                weightsLoaded = true;
                document.getElementById('nodeCount').innerText = weightArray.length;
            }
        });

        function extractWeights(obj) {
            if (typeof obj === 'number') weightArray.push(obj);
            else if (Array.isArray(obj)) obj.forEach(extractWeights);
            else if (obj && typeof obj === 'object') Object.values(obj).forEach(extractWeights);
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = performance.now() * 0.001;
            coreMaterial.uniforms.uTime.value = t;

            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                const avg = dataArray.reduce((a, b) => a + b) / dataArray.length / 255;
                coreMaterial.uniforms.uAudioAmp.value = avg;
                document.getElementById('amp').innerText = avg.toFixed(2);

                const bass = dataArray[2] / 255;
                const mid = dataArray[15] / 255;
                const high = dataArray[40] / 255;
                coreMaterial.uniforms.uColor.value.setRGB(bass, mid, high);
                coreMaterial.uniforms.uAutonomy.value = BASE_AUTONOMY + (bass * 0.5);
            }

            if (weightsLoaded) {
                const w = weightArray[Math.floor(t * 10) % weightArray.length];
                const sync = Math.min(100, (95 + Math.abs(w) * 5));
                document.getElementById('sync').innerText = sync.toFixed(2) + '%';
            }

            singularity.rotation.y += 0.005;
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
